<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FcTeamChat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <!-- 样式 -->
    <link rel="stylesheet" href="./static/css/mui.min.css">
    <link rel="stylesheet" href="./static/css/im.css">
    <script src="./static/js/jquery.min.js"></script>
    <script src="./static/js/json2.js"></script>
</head>
<body>
<header class="mui-bar mui-bar-nav">
    <a id="logout" class="mui-icon mui-icon-undo mui-pull-left"></a>
    <a id="aboutInfo" class="mui-icon mui-icon-info-filled mui-pull-right" style="color: #999;"></a>
    <h1 class="mui-title">FcTeamChat</h1>
</header>

<div class="mui-content">
    <div id='msg-list'>

    </div>
</div>


<footer>
    <div class="footer-center">
        <input id='msgText' style="left:-10px;" type="text" placeholder="输入消息内容" class='input-text'>
    </div>
    <label class="footer-right">
        <i id='postMsg' class="mui-icon mui-icon-paperplane"></i>
    </label>
</footer>

<script src="./static/js/mui.min.js"></script>
<script>
    var socket;
    //注册账号
    function register()
    {
        mui.prompt('请输入您昵称：', '昵称', 'FcTeamChat', ['提交'], function(e) {
            if (e.index == 0) {
                if(e.value != ""){
                    login(e.value);
                    return;
                }
                setTimeout("register()", 600);
                return;
            }
        });
    };

    //检测用户
    function checkUser()
    {
        var userInfo = sessionStorage.getItem("chatUser");
        if( !userInfo ){
            register();
            return;
        }else{
            userInfo = $.parseJSON( userInfo );
        }
        return userInfo;
    }

    //登录
    function login(name)
    {
        socketInit(0, {uname: name});
    }

    //退出
    function logout()
    {
        //发送退出消息
        socket.send( '{"type" : 3}' );
        sessionStorage.removeItem("chatUser");
    }

    //发送消息
    function sendMessage()
    {
        var userInfo = checkUser();

        if( userInfo ){
            var msg = '{"type" : 2, "uname" : "' + userInfo.uname + '", "avatar" : "' + userInfo.avatar + '", "msg": "' + $("#msgText").val() + '"}';
            //发送消息
            socket.send( msg );
            //消息Dom节点
            var message = parseMessage( userInfo.uname, userInfo.avatar, $("#msgText").val(), 0 );
            $("#msg-list").append( message );

            //滚动条自动定位到最底端
            var ex = document.getElementById("msg-list");
            ex.scrollTop = ex.scrollHeight;
        }
    }

    //解析消息发送样式
    function parseMessage(uname, avatar, message, type)
    {
        var _html = "<div class='msg-item ";
        if(type == 0) _html += 'msg-item-self';
        _html += "'>";
        _html += "<img class='msg-user msg-user-img' src='"+avatar+"' alt='' />"
        _html += "<i class='msg-uname'>"+uname+"</i>";
        _html += "<div class='msg-content'>";
        _html += "<div class='msg-content-inner'>";
        _html += message;
        _html += "</div>";
        _html += "<div class='msg-content-arrow'></div>";
        _html += "</div>";
        _html += "<div class='mui-item-clear'></div>";
        _html += "</div>";
        return _html;
    }

    //chat 初始化
    function chatInit() {
        var chatUser = sessionStorage.getItem("chatUser");
        if(chatUser){
            socketInit(1, eval('('+chatUser+')'));
        } else {
            register();
        }
    }

    //socket 初始化
    function socketInit(bool, data) {

        try {
            //  创建一个Socket实例
            socket = new WebSocket("ws://192.168.1.14:8099");

            console.log(socket);

            //  打开Socket
            socket.onopen = function(e){
                console.log("握手成功!");
                if(bool == 1) {
                    //更新用户资料
                    console.log(data);
                    socket.send( '{"type" : 5, "uname" : "' + data.uname + '", "avatar" : "' + data.avatar + '"}' );
                } else {
                    //获取头像
                    var avatar = Math.floor(Math.random()*10+1);
                    avatar = './static/images/avatar/a'+avatar+'.jpg';
                    //保存用户信息
                    sessionStorage.setItem('chatUser', '{ "uname" : "' + data.uname + '", "avatar" : "' + avatar + '"}');
                    //发送上线通知
                    socket.send( '{"type" : 0, "uname" : "' + data.uname + '", "avatar" : "' + avatar + '"}' );
                }
            }

            //  接收Socket消息
            socket.onmessage = function(e){
                //解析json数据
                var data = $.parseJSON( e.data );

                console.log(data);

                switch(data.type)
                {
                    case 1:
                        //通知
                        mui.toast(data.user.uname+" "+data.msg);
                        break;
                    case 2:
                        //普通消息
                        var message = parseMessage( data.user.uname, data.user.avatar, data.msg );
                        $("#msg-list").append( message );
                        //滚动条自动定位到最底端
                        var ex = document.getElementById("msg-list");
                        ex.scrollTop = ex.scrollHeight;
                        break;
                    case 3:
                        //断开连接
                        mui.toast(data.user.uname+" "+data.msg);
                        break;
                    case 4:
                        //错误
                        mui.alert(data.msg, 'FcTeamChat');
                        break;
                }
            }
            //  监听Socket关闭
            socket.onclose = function(e) {
                console.log("Socket关闭");
                logout();
                mui.alert("连接服务器中断!", "FcTeamChat", function() {
                    register();
                });
            };
            //  Socket出错
            socket.onerror = function(e){
                console.log("Socket出错");
                logout();
            }

        } catch (err){
            console.log(err.description);
        }

    }
    
    window.onload = function(){
        //mui初始化
        mui.init({});
        //关于
        document.getElementById("aboutInfo").addEventListener('tap', function() {
            mui.toast('欢迎体验FcTeamChat');
        });
        document.getElementById("logout").addEventListener('tap', function() {
            mui.confirm( "确认退出么？", "提示", ["是", "否"], function(e){
                if(e.index == 0){
                    //退出处理
                    logout();
                    //刷新当前页
                    location.reload();
                }
            });
        });
        //发送信息
        document.getElementById("postMsg").addEventListener('click', function() {
            if($("#msgText").val() == ""){
                mui.alert("请输入消息内容!", 'FcTeamChat');
                return;
            }
            //发送消息
            sendMessage();
            //重置消息输入框
            $("#msgText").val("");
        });
        //发送信息
        document.getElementById("postMsg").addEventListener('keydown', function(e) {
            if($("#msgText").val() == ""){
                mui.alert("请输入消息内容!", 'FcTeamChat');
                return;
            }
            if(e.keyCode!=13) return;
            e.preventDefault();  //取消事件的默认动作
            //发送消息
            sendMessage();
            //重置消息输入框
            $("#msgText").val("");
        });

        //初始化
        chatInit();
    }
</script>
</body>
</html>